<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Data\Function\Vargs.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE TemplateHaskell, FlexibleInstances #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>{- |
<a name="line-4"></a>Module      : Data.Function.Vargs
<a name="line-5"></a>Description : Support variable number of function parameters
<a name="line-6"></a>Copyright   : (c) Wardopdem 2017                  
<a name="line-7"></a>License     : GPL-3
<a name="line-8"></a>Maintainer  : wardopdem@gmail.com                 
<a name="line-9"></a>Stability   : experimental
<a name="line-10"></a>Portability : non-portable (GHC extesions)
<a name="line-11"></a>
<a name="line-12"></a>Types and functions for gereration declarations 
<a name="line-13"></a>for realizations variable number of function parameters.
<a name="line-14"></a>-}</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Function</span><span class='hs-varop'>.</span><span class='hs-conid'>Vargs</span> <span class='hs-layout'>(</span>
<a name="line-17"></a>    <span class='hs-comment'>-- * Функция для реализации переменнго числа параметров.</span>
<a name="line-18"></a>    <span class='hs-varid'>defVargsFun</span><span class='hs-layout'>,</span>
<a name="line-19"></a>    <span class='hs-comment'>-- * Классы и типы для реализации механизма переменного числа параметров</span>
<a name="line-20"></a>    <span class='hs-conid'>InstMaker</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstMakerQ</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstSrc</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>  <span class='hs-conid'>ArgProc</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Genz</span>
<a name="line-21"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span> 
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Syntax</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>M</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="InstMaker"></a><span class='hs-comment'>-- | Генератор экземпляров</span>
<a name="line-28"></a><a name="InstMaker"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InstMaker</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DecsQ</span>   
<a name="line-29"></a><span class='hs-comment'>-- ^ * :: класс </span>
<a name="line-30"></a><span class='hs-comment'>-- * -&gt; тип </span>
<a name="line-31"></a><span class='hs-comment'>-- * -&gt; метод </span>
<a name="line-32"></a><span class='hs-comment'>-- * -&gt; декларации экземпляров</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="InstMakerQ"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InstMakerQ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Q</span> <span class='hs-conid'>InstMaker</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="InstSrc"></a><span class='hs-comment'>-- | Источник генератора экземпляров - тип, на основе которого можно построить процедуру генерации экземпляров</span>
<a name="line-37"></a><a name="InstSrc"></a><span class='hs-keyword'>class</span> <span class='hs-conid'>InstSrc</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>where</span>
<a name="line-38"></a>    <span class='hs-comment'>-- | Создание генератора экземпляров класса типов элементов списка парметров </span>
<a name="line-39"></a>    <span class='hs-comment'>--  для типа @a@</span>
<a name="line-40"></a>    <span class='hs-varid'>toMaker</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InstMakerQ</span> <span class='hs-comment'>-- ^ генератор экземпляров для заданного типа</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="mkTpHndl"></a><span class='hs-definition'>mkTpHndl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Exp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InstMakerQ</span>
<a name="line-43"></a><span class='hs-definition'>mkTpHndl</span> <span class='hs-varid'>c</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>cnt_as</span> <span class='hs-varid'>cnt_at</span> <span class='hs-varid'>mt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-44"></a>    <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstanceD</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>c</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>cnt_as</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ValD</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarP</span> <span class='hs-varid'>mt</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>NormalB</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="instance%20InstSrc%20(Name,%20ExpQ)"></a><span class='hs-comment'>-- | Для пар вида: @(''Type,  [| doIt |])@</span>
<a name="line-47"></a><a name="instance%20InstSrc%20(Name,%20ExpQ)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>InstSrc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExpQ</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-48"></a>    <span class='hs-varid'>toMaker</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-49"></a>        <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>e</span> 
<a name="line-50"></a>        <span class='hs-varid'>mkTpHndl</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConT</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>e'</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="instance%20InstSrc%20(TypeQ,%20ExpQ)"></a><span class='hs-comment'>-- | Для пар вида: @([t| [Int] |],  [| doIt |])@ </span>
<a name="line-53"></a><a name="instance%20InstSrc%20(TypeQ,%20ExpQ)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>InstSrc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeQ</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExpQ</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-54"></a>    <span class='hs-varid'>toMaker</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-55"></a>        <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>t</span> 
<a name="line-56"></a>        <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>e</span> 
<a name="line-57"></a>        <span class='hs-varid'>mkTpHndl</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>t'</span> <span class='hs-varid'>e'</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="concIms"></a><span class='hs-comment'>-- | Комбинатор генераторов экземпляров: строит новый генератор, </span>
<a name="line-60"></a><span class='hs-comment'>-- который выполняет заданные списком генераторы и объединяет их результаты </span>
<a name="line-61"></a><span class='hs-definition'>concIms</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstMaker</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InstMakerQ</span>
<a name="line-62"></a><span class='hs-definition'>concIms</span> <span class='hs-varid'>ims</span> <span class='hs-keyglyph'>=</span>  
<a name="line-63"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>cnt_as</span> <span class='hs-varid'>cnt_at</span> <span class='hs-varid'>mt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-64"></a>        <span class='hs-varid'>decs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequenceQ</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>i</span> <span class='hs-varid'>cnt_as</span> <span class='hs-varid'>cnt_at</span> <span class='hs-varid'>mt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ims</span> 
<a name="line-65"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>decs</span>
<a name="line-66"></a>               
<a name="line-67"></a><a name="instance%20InstSrc%20(%5bName%5d,%20ExpQ)"></a><span class='hs-comment'>-- | Для пар вида: @([''Type1, ''Type2, ...],  [| doIt |])@ </span>
<a name="line-68"></a><a name="instance%20InstSrc%20(%5bName%5d,%20ExpQ)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>InstSrc</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExpQ</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-69"></a>    <span class='hs-varid'>toMaker</span> <span class='hs-layout'>(</span><span class='hs-varid'>ns</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-70"></a>        <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>e</span>
<a name="line-71"></a>        <span class='hs-varid'>ims</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequenceQ</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkTpHndl</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConT</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ns</span><span class='hs-keyglyph'>]</span>
<a name="line-72"></a>        <span class='hs-varid'>concIms</span> <span class='hs-varid'>ims</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="instance%20InstSrc%20%5bName%5d"></a><span class='hs-comment'>-- | Для списка имён типов вида @[''Integer, ''Double, ...]@.</span>
<a name="line-75"></a><a name="instance%20InstSrc%20%5bName%5d"></a><span class='hs-comment'>-- Подразумевается, что тип списка параметров имеет </span>
<a name="line-76"></a><a name="instance%20InstSrc%20%5bName%5d"></a><span class='hs-comment'>-- единственный конструктор с единственным аргументом (тип-обёртка) - этот конструктор </span>
<a name="line-77"></a><a name="instance%20InstSrc%20%5bName%5d"></a><span class='hs-comment'>-- и используется в качестве "тела" метода создания значений из исходных типов</span>
<a name="line-78"></a><a name="instance%20InstSrc%20%5bName%5d"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>InstSrc</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>where</span>
<a name="line-79"></a>    <span class='hs-varid'>toMaker</span> <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-80"></a>        <span class='hs-varid'>ims</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequenceQ</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkTpHndl'</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConT</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ns</span><span class='hs-keyglyph'>]</span>
<a name="line-81"></a>        <span class='hs-varid'>concIms</span> <span class='hs-varid'>ims</span>
<a name="line-82"></a>            <span class='hs-keyword'>where</span> <span class='hs-varid'>mkTpHndl'</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>cnt_as</span> <span class='hs-varid'>cnt_at</span> <span class='hs-varid'>mt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-83"></a>                    <span class='hs-varid'>wc</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapCons</span> <span class='hs-varid'>cnt_at</span>  
<a name="line-84"></a>                    <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstanceD</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>cnt_as</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ValD</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarP</span> <span class='hs-varid'>mt</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>NormalB</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-85"></a>                  <span class='hs-varid'>wrapCons</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConT</span> <span class='hs-varid'>cn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-86"></a>                    <span class='hs-conid'>TyConI</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataD</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ForallC</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>NormalC</span> <span class='hs-varid'>cn'</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reify</span> <span class='hs-varid'>cn</span>
<a name="line-87"></a>                    <span class='hs-varid'>conE</span> <span class='hs-varid'>cn'</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="Genz"></a><span class='hs-comment'>-- | Обёртка для декларации необходимости генерации "обобщённого" экзепляра вида </span>
<a name="line-90"></a><a name="Genz"></a><span class='hs-comment'>--</span>
<a name="line-91"></a><a name="Genz"></a><span class='hs-comment'>-- @a ~ T1, b ~ T2 =&gt; C a b ...@</span>
<a name="line-92"></a><a name="Genz"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>Genz</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Genz</span> <span class='hs-conid'>TypeQ</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="instance%20InstSrc%20(Genz,%20ExpQ)"></a><span class='hs-comment'>-- | Для пар вида  (Genz [t| ... |], [| expr |]).</span>
<a name="line-95"></a><a name="instance%20InstSrc%20(Genz,%20ExpQ)"></a><span class='hs-comment'>-- Строит генератор экземпляров вида </span>
<a name="line-96"></a><a name="instance%20InstSrc%20(Genz,%20ExpQ)"></a><span class='hs-comment'>--  @a ~ T1, b ~ T2, ... =&gt; C a b ...@</span>
<a name="line-97"></a><a name="instance%20InstSrc%20(Genz,%20ExpQ)"></a><span class='hs-comment'>-- для типов вида  Tp T1 T2 ... (например Double -&gt; Double -&gt; Double)</span>
<a name="line-98"></a><a name="instance%20InstSrc%20(Genz,%20ExpQ)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>InstSrc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Genz</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExpQ</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-99"></a>    <span class='hs-varid'>toMaker</span> <span class='hs-layout'>(</span><span class='hs-conid'>Genz</span> <span class='hs-varid'>tq</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-100"></a>        <span class='hs-varid'>t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tq</span> 
<a name="line-101"></a>        <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>e</span>
<a name="line-102"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctx</span><span class='hs-layout'>,</span> <span class='hs-varid'>t'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>genzType</span> <span class='hs-varid'>t</span> 
<a name="line-103"></a>        <span class='hs-varid'>mkTpHndl</span> <span class='hs-varid'>ctx</span> <span class='hs-varid'>t'</span> <span class='hs-varid'>e'</span>
<a name="line-104"></a>            <span class='hs-keyword'>where</span>
<a name="line-105"></a>              <span class='hs-comment'>-- | Генерация для типа вида: </span>
<a name="line-106"></a>              <span class='hs-comment'>--  </span>
<a name="line-107"></a>              <span class='hs-comment'>--    Q T1 T2 ... </span>
<a name="line-108"></a>              <span class='hs-comment'>--</span>
<a name="line-109"></a>              <span class='hs-comment'>--   пары вида (псевдокод):</span>
<a name="line-110"></a>              <span class='hs-comment'>-- </span>
<a name="line-111"></a>              <span class='hs-comment'>--  ([a ~ T1, b ~ T2, ... ], Q a b ...)</span>
<a name="line-112"></a>              <span class='hs-comment'>--</span>
<a name="line-113"></a>              <span class='hs-comment'>-- т.е. контекста типов и полиморфного типа в этом контексте.</span>
<a name="line-114"></a>              <span class='hs-varid'>genzType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-115"></a>              <span class='hs-varid'>genzType</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ConT</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-116"></a>              <span class='hs-varid'>genzType</span> <span class='hs-varid'>tp</span> <span class='hs-keyglyph'>=</span>
<a name="line-117"></a>                  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>work</span> <span class='hs-varid'>tp</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-varid'>tpVars</span> 
<a name="line-118"></a>                  <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkCtx</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>assocs</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>   
<a name="line-119"></a>                      <span class='hs-keyword'>where</span> <span class='hs-varid'>work</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConT</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span>
<a name="line-120"></a>                              <span class='hs-keyword'>case</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-121"></a>                                  <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkName</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-122"></a>                                  <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span> 
<a name="line-123"></a>                                             <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkName</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>s</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span>
<a name="line-124"></a>                            <span class='hs-varid'>work</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> 
<a name="line-125"></a>                              <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>t'</span><span class='hs-layout'>,</span> <span class='hs-varid'>m'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>work</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tvs</span>
<a name="line-126"></a>                              <span class='hs-keyword'>in</span>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>t''</span><span class='hs-layout'>,</span> <span class='hs-varid'>m''</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs''</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>work</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>m'</span> <span class='hs-varid'>tvs'</span>
<a name="line-127"></a>                                  <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>t'</span> <span class='hs-varid'>t''</span><span class='hs-layout'>,</span> <span class='hs-varid'>m''</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs''</span><span class='hs-layout'>)</span>
<a name="line-128"></a>                            <span class='hs-varid'>work</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-129"></a>                            <span class='hs-varid'>mkCtx</span> <span class='hs-layout'>(</span><span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AppT</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-conid'>EqualityT</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkName</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConT</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span>
<a name="line-130"></a>                            <span class='hs-varid'>tpVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-chr'>'a'</span><span class='hs-keyglyph'>..</span><span class='hs-chr'>'z'</span><span class='hs-keyglyph'>]</span>  
<a name="line-131"></a>
<a name="line-132"></a><a name="ArgProc"></a><span class='hs-comment'>-- | Обработчик переменного числа параметров функции defVargsFun</span>
<a name="line-133"></a><a name="ArgProc"></a><span class='hs-keyword'>class</span> <span class='hs-conid'>ArgProc</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>where</span>
<a name="line-134"></a>    <span class='hs-comment'>-- | Реализация механизма накопления/обработки параметров (InstMakerQ)</span>
<a name="line-135"></a>    <span class='hs-varid'>prc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>       <span class='hs-comment'>-- ^ Имя создаваемой функции-обёртки над @prc@.     </span>
<a name="line-136"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- ^ Список имён функций, которые будут использованы в терминальных </span>
<a name="line-137"></a>                        <span class='hs-comment'>-- экземплярах (отдельный экземпляр для каждой функции). Каждая из функций должна иметь </span>
<a name="line-138"></a>                        <span class='hs-comment'>-- идентичный набор типов параметров и уникальный тип возврата.</span>
<a name="line-139"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstMakerQ</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ Поставщики информации для генераторов экземпляров. </span>
<a name="line-140"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>           
<a name="line-141"></a>
<a name="line-142"></a><a name="instance%20ArgProc%20DecsQ"></a><span class='hs-comment'>-- | терминальный обработчик - генератор всех необходимых деклараций</span>
<a name="line-143"></a><a name="instance%20ArgProc%20DecsQ"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ArgProc</span> <span class='hs-conid'>DecsQ</span> <span class='hs-keyword'>where</span>
<a name="line-144"></a>    <span class='hs-varid'>prc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defVargsFun'</span>
<a name="line-145"></a>
<a name="line-146"></a><a name="instance%20ArgProc%20(a%20-%3e%20r)"></a><span class='hs-comment'>-- | "Магия" переменного числа параметров</span>
<a name="line-147"></a><a name="instance%20ArgProc%20(a%20-%3e%20r)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstSrc</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArgProc</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ArgProc</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-148"></a>    <span class='hs-comment'>-- | Накапливаем генераторы экземпляров для типов, допускающих конвертацию </span>
<a name="line-149"></a>    <span class='hs-comment'>-- в тип параметра функции с переменным числом параметров</span>
<a name="line-150"></a>    <span class='hs-varid'>prc</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>e</span> <span class='hs-varid'>sts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prc</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>e</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span> <span class='hs-varid'>sts</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>toMaker</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="defVargsFun"></a><span class='hs-comment'>-- | Генератор деклараций для реализации переменного числа </span>
<a name="line-153"></a><span class='hs-comment'>-- параметров - основная экспортируемая функция (с переменным числом параметров).</span>
<a name="line-154"></a><span class='hs-definition'>defVargsFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArgProc</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-155"></a><span class='hs-definition'>defVargsFun</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>e</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prc</span> <span class='hs-varid'>fn</span>  <span class='hs-varid'>e</span> <span class='hs-conid'>[]</span>
<a name="line-156"></a>
<a name="line-157"></a><a name="defVargsFun'"></a><span class='hs-comment'>-- | Фактическая  генерация деклараций для реализации переменного числа параметров</span>
<a name="line-158"></a><span class='hs-definition'>defVargsFun'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>        <span class='hs-comment'>-- ^ Имя для создаваемой функци с переменным числом параметров (далее, Функция).</span>
<a name="line-159"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- ^ Список имён функций, которые быдут выступать в качестве обработчиков параметров.</span>
<a name="line-160"></a>                              <span class='hs-comment'>-- Каждая из функций должна иметь идентичный набор типов параметров и уникальный тип возврата.</span>
<a name="line-161"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstMakerQ</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- ^ Список генераторов экземпляров для "неявного приведения" заданных типов в классу параметров </span>
<a name="line-162"></a>                              <span class='hs-comment'>-- создаваемой функции</span>
<a name="line-163"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DecsQ</span>         <span class='hs-comment'>-- ^ Список необходимых деклараций классов, экземпляров и функций</span>
<a name="line-164"></a><span class='hs-definition'>defVargsFun'</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>srcFns</span> <span class='hs-varid'>sts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-165"></a>    <span class='hs-comment'>-- Генерация имён необходимых классов и методов</span>
<a name="line-166"></a>    <span class='hs-varid'>argPrc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nn</span> <span class='hs-str'>"ArgPrc"</span> <span class='hs-comment'>-- Основной класс для обраобтки переменного числа параметров (далее, Класс).</span>
<a name="line-167"></a>    <span class='hs-varid'>argSrc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nn</span> <span class='hs-str'>"ArgSrc"</span> <span class='hs-comment'>-- Класс для типов, допускающихся в качестве параметров Функции (далее, Источник).</span>
<a name="line-168"></a>    <span class='hs-varid'>prc</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nn</span> <span class='hs-str'>"prc"</span>    <span class='hs-comment'>-- Ключевой (и единственный) метод Класса.</span>
<a name="line-169"></a>    <span class='hs-varid'>acc</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nn</span> <span class='hs-str'>"acc"</span>    <span class='hs-comment'>-- Параметр-накопитель (список) параметров.</span>
<a name="line-170"></a>    <span class='hs-varid'>toArg</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nn</span> <span class='hs-str'>"toArg"</span>  <span class='hs-comment'>-- Ключевой (и единственный) метод Источника: создание значения </span>
<a name="line-171"></a>                          <span class='hs-comment'>-- типа Элемент (см. ниже) из значения типа класса Источник</span>
<a name="line-172"></a>        <span class='hs-comment'>-- Для первой функции - остальные должны отличаться только типом возврата</span>
<a name="line-173"></a>    <span class='hs-varid'>funs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- исходный тип функции с типом возврата заменённым на @a@                                              </span>
<a name="line-174"></a>           <span class='hs-varid'>t'</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- исходный тип функции без последнего параметра (списка) и с типом возврата заменённым на @a@</span>
<a name="line-175"></a>           <span class='hs-varid'>rt</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- результирующий тип функции                                                                             </span>
<a name="line-176"></a>           <span class='hs-varid'>cnt_at</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- тип элементов списка для типа последнего параметра (далее, Элемент)</span>
<a name="line-177"></a>           <span class='hs-varid'>nms</span>     <span class='hs-comment'>-- список имён параметров вида a1, a2, ... </span>
<a name="line-178"></a>           <span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequenceQ</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>splitType</span> <span class='hs-varid'>srcFns</span> <span class='hs-comment'>-- Разбираем типы функций - финальных обработчиков параметров</span>
<a name="line-179"></a>    <span class='hs-comment'>-- Используемые типы</span>
<a name="line-180"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>cnt_a</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ConT</span> <span class='hs-varid'>nm_a</span>
<a name="line-181"></a>        <span class='hs-varid'>vrt_a</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarT</span> <span class='hs-varid'>nm_a</span>
<a name="line-182"></a>        <span class='hs-varid'>vrt_r</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarT</span> <span class='hs-varid'>nm_r</span>
<a name="line-183"></a>        <span class='hs-varid'>cnt_ap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ConT</span> <span class='hs-varid'>argPrc</span>
<a name="line-184"></a>        <span class='hs-varid'>cnt_as</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ConT</span> <span class='hs-varid'>argSrc</span>
<a name="line-185"></a>    <span class='hs-comment'>-- Извлекаем генераторы из монады Q</span>
<a name="line-186"></a>    <span class='hs-varid'>sts'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequenceQ</span> <span class='hs-varid'>sts</span> 
<a name="line-187"></a>    <span class='hs-comment'>-- Запускаем генераторы для построения деклараций экземпляров класса Источник</span>
<a name="line-188"></a>    <span class='hs-varid'>insts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequenceQ</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>i</span> <span class='hs-varid'>cnt_as</span> <span class='hs-varid'>cnt_at</span> <span class='hs-varid'>toArg</span><span class='hs-layout'>)</span> <span class='hs-varid'>sts'</span> 
<a name="line-189"></a>    <span class='hs-comment'>-- Возвращаем список всех необходимых деклараций</span>
<a name="line-190"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-comment'>-- Класс</span>
<a name="line-191"></a>             <span class='hs-keyglyph'>[</span><span class='hs-varid'>cls</span> <span class='hs-varid'>argPrc</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SigD</span> <span class='hs-varid'>prc</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-192"></a>             <span class='hs-comment'>-- Класс для типов, допускающихся в качестве параметров Функции (далее, Источник)</span>
<a name="line-193"></a>             <span class='hs-keyglyph'>[</span><span class='hs-varid'>cls</span> <span class='hs-varid'>argSrc</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SigD</span> <span class='hs-varid'>toArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-conid'>ArrowT</span> <span class='hs-varid'>vrt_a</span><span class='hs-layout'>)</span> <span class='hs-varid'>cnt_at</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-194"></a>             <span class='hs-comment'>-- Экземпляры Класса для терминальных типов: ключевой метод (prc_xxx) вызывает одну из </span>
<a name="line-195"></a>             <span class='hs-comment'>-- функций srcFns (туб тип возврата которой фигурирует в экземпляре)</span>
<a name="line-196"></a>             <span class='hs-keyglyph'>[</span><span class='hs-varid'>inst</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>cnt_ap</span> <span class='hs-varid'>rt'</span><span class='hs-layout'>)</span> 
<a name="line-197"></a>                    <span class='hs-keyglyph'>[</span><span class='hs-conid'>FunD</span> <span class='hs-varid'>prc</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Clause</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>VarP</span> <span class='hs-varid'>nms'</span><span class='hs-layout'>)</span>
<a name="line-198"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>NormalB</span> <span class='hs-varop'>$</span> <span class='hs-varid'>conv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>foldl</span> <span class='hs-conid'>AppE</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarE</span> <span class='hs-varid'>srcFn</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>VarE</span> <span class='hs-varid'>nms'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>VarE</span> <span class='hs-chr'>'</span><span class='hs-varid'>reverse</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> 
<a name="line-199"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcFn</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rt'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>nms'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>srcFns</span> <span class='hs-varid'>funs</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-200"></a>             <span class='hs-comment'>-- Экземпляр Класса для "магии" накопления параметров типов класса Источник</span>
<a name="line-201"></a>             <span class='hs-keyglyph'>[</span><span class='hs-varid'>inst</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>cnt_as</span> <span class='hs-varid'>vrt_a</span><span class='hs-layout'>,</span> <span class='hs-conid'>AppT</span> <span class='hs-varid'>cnt_ap</span> <span class='hs-varid'>vrt_r</span><span class='hs-keyglyph'>]</span>  <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>cnt_ap</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-conid'>ArrowT</span> <span class='hs-varid'>vrt_a</span><span class='hs-layout'>)</span> <span class='hs-varid'>vrt_r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  
<a name="line-202"></a>                    <span class='hs-keyglyph'>[</span><span class='hs-conid'>FunD</span> <span class='hs-varid'>prc</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Clause</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>VarP</span> <span class='hs-varid'>nms</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>VarP</span> <span class='hs-varid'>acc</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-203"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>NormalB</span> <span class='hs-varop'>$</span> <span class='hs-varid'>conv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>foldl</span> <span class='hs-conid'>AppE</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarE</span> <span class='hs-varid'>prc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>VarE</span> <span class='hs-varid'>nms</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>conv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>consTo</span> <span class='hs-varid'>acc</span><span class='hs-layout'>,</span> <span class='hs-conid'>VarE</span> <span class='hs-varid'>toArg</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-204"></a>             <span class='hs-comment'>-- Экземпляр класса Источник для самого типа Элемент</span>
<a name="line-205"></a>             <span class='hs-keyglyph'>[</span><span class='hs-varid'>inst</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>cnt_as</span> <span class='hs-varid'>cnt_at</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ValD</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarP</span> <span class='hs-varid'>toArg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>NormalB</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarE</span> <span class='hs-chr'>'</span><span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-206"></a>             <span class='hs-comment'>-- Экземпляры класса Источник для всех запрошенных типов</span>
<a name="line-207"></a>             <span class='hs-varid'>concat</span> <span class='hs-varid'>insts</span> <span class='hs-varop'>++</span>
<a name="line-208"></a>             <span class='hs-comment'>-- Декларация и определение Функции</span>
<a name="line-209"></a>             <span class='hs-keyglyph'>[</span><span class='hs-conid'>SigD</span> <span class='hs-varid'>nm</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ForallT</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptv_a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>cnt_ap</span> <span class='hs-varid'>vrt_a</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>t'</span><span class='hs-layout'>,</span>
<a name="line-210"></a>              <span class='hs-conid'>FunD</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Clause</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>VarP</span> <span class='hs-varid'>nms</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>NormalB</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldl1</span> <span class='hs-conid'>AppE</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>VarE</span> <span class='hs-varid'>prc</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>VarE</span> <span class='hs-varid'>nms</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ListE</span> <span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> 
<a name="line-211"></a>
<a name="line-212"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>nn</span> <span class='hs-varid'>pref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pref</span> <span class='hs-varop'>++</span> <span class='hs-str'>"_"</span>  <span class='hs-varop'>++</span> <span class='hs-varid'>fn</span>
<a name="line-213"></a>              <span class='hs-comment'>-- Cтроит из списка [Exp] конвеер: exp1 . exp2 . ...</span>
<a name="line-214"></a>              <span class='hs-varid'>conv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr1</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InfixE</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarE</span> <span class='hs-chr'>'</span><span class='hs-layout'>(</span><span class='hs-varop'>.</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> 
<a name="line-215"></a>              <span class='hs-varid'>cls</span> <span class='hs-varid'>c</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ClassD</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptv_a</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>[]</span>
<a name="line-216"></a>              <span class='hs-varid'>inst</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstanceD</span> <span class='hs-conid'>Nothing</span> 
<a name="line-217"></a>              <span class='hs-varid'>consTo</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InfixE</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConE</span> <span class='hs-chr'>'</span><span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>.</span> <span class='hs-conid'>VarE</span> 
<a name="line-218"></a>              <span class='hs-varid'>nm</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkName</span> <span class='hs-varid'>fn</span>
<a name="line-219"></a>              <span class='hs-varid'>nm_a</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkName</span> <span class='hs-str'>"a"</span>
<a name="line-220"></a>              <span class='hs-varid'>ptv_a</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PlainTV</span> <span class='hs-varid'>nm_a</span>
<a name="line-221"></a>              <span class='hs-varid'>nm_r</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkName</span> <span class='hs-str'>"r"</span>
<a name="line-222"></a>              <span class='hs-comment'>-- Разбиение типа функции вида T1 -&gt; T2 -&gt; ... -&gt; [A] -&gt; R на составные элементы, генерация вспомогательных имён</span>
<a name="line-223"></a>              <span class='hs-varid'>splitType</span> 
<a name="line-224"></a>                  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>                               <span class='hs-comment'>-- ^ Имя функции</span>
<a name="line-225"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Q</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> 
<a name="line-226"></a>                  <span class='hs-comment'>-- ^ * исходный тип функции с типов возврата заменённым на @a@</span>
<a name="line-227"></a>                  <span class='hs-comment'>-- * исходный тип функции без последнего параметра (массива) и с типов возврата заменённым на @a@</span>
<a name="line-228"></a>                  <span class='hs-comment'>-- * результирующий тип функции</span>
<a name="line-229"></a>                  <span class='hs-comment'>-- * тип элементов списка для типа последнего параметра: тип A для функци вида T1 -&gt; T2 -&gt; ... -&gt; [A] -&gt; R</span>
<a name="line-230"></a>                  <span class='hs-comment'>-- * список имён параметров вида a1, a2, ... количеством равным число параметов в исходном типе-функции - 1</span>
<a name="line-231"></a>                  <span class='hs-comment'>--</span>
<a name="line-232"></a>                  <span class='hs-comment'>-- Пример:</span>
<a name="line-233"></a>                  <span class='hs-comment'>--</span>
<a name="line-234"></a>                  <span class='hs-comment'>--  для функции типа: Int -&gt; String -&gt; [Double] -&gt; IO () </span>
<a name="line-235"></a>                  <span class='hs-comment'>--  получим: ( Int -&gt; String -&gt; [Double] -&gt; a, Int -&gt; String -&gt; a, R, A. ['a1, 'a2] )</span>
<a name="line-236"></a>              <span class='hs-varid'>splitType</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-237"></a>                  <span class='hs-conid'>VarI</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reify</span> <span class='hs-varid'>nm</span>
<a name="line-238"></a>                  <span class='hs-keyword'>let</span> <span class='hs-varid'>tps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funTypes</span> <span class='hs-varid'>rt</span>
<a name="line-239"></a>                      <span class='hs-varid'>t</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>init</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tps</span>
<a name="line-240"></a>                      <span class='hs-varid'>t'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>init</span> <span class='hs-varop'>.</span> <span class='hs-varid'>init</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tps</span>
<a name="line-241"></a>                  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>t'</span><span class='hs-layout'>,</span> <span class='hs-varid'>last</span> <span class='hs-varid'>tps</span><span class='hs-layout'>,</span> 
<a name="line-242"></a>                          <span class='hs-keyword'>let</span> <span class='hs-conid'>AppT</span> <span class='hs-conid'>ArrowT</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-conid'>ListT</span> <span class='hs-varid'>at</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>last</span> <span class='hs-varop'>.</span> <span class='hs-varid'>init</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tps</span> <span class='hs-keyword'>in</span> <span class='hs-varid'>at</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- выделяем тип элемента списка</span>
<a name="line-243"></a>                          <span class='hs-varid'>map</span> <span class='hs-varid'>mkName</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"a"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tps</span> <span class='hs-comment'>-</span> <span class='hs-num'>2</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> 
<a name="line-244"></a>                      <span class='hs-keyword'>where</span> <span class='hs-comment'>-- | Собираем обратнофункциональный тип из сипска типов элементов и результата (обратная funTypes).</span>
<a name="line-245"></a>                            <span class='hs-comment'>--</span>
<a name="line-246"></a>                            <span class='hs-comment'>-- Пример (псевдокод): mkType [a, b-&gt; c, [d], r] ==&gt; a -&gt; (b -&gt; c) -&gt; [d] -&gt; r</span>
<a name="line-247"></a>                            <span class='hs-varid'>mkType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr1</span> <span class='hs-conid'>AppT</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>VarT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkName</span> <span class='hs-str'>"a"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-248"></a>                            <span class='hs-comment'>-- | Разбиваем тип функции на типы апраметров и результата.</span>
<a name="line-249"></a>                            <span class='hs-comment'>--</span>
<a name="line-250"></a>                            <span class='hs-comment'>-- Пример (псевдокод): funTypes a -&gt; (b -&gt; c) -&gt; [d] -&gt; r ==&gt; [a, b-&gt; c, [d], r]</span>
<a name="line-251"></a>                            <span class='hs-varid'>funTypes</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-conid'>ArrowT</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-conop'>:</span> <span class='hs-varid'>funTypes</span> <span class='hs-varid'>x</span>
<a name="line-252"></a>                            <span class='hs-varid'>funTypes</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>
</pre></body>
</html>
